'use strict';

var _express = require('express');

var _express2 = _interopRequireDefault(_express);

var _webpack = require('webpack');

var _webpack2 = _interopRequireDefault(_webpack);

var _dotenv = require('dotenv');

var _dotenv2 = _interopRequireDefault(_dotenv);

var _setupExpress = require('./setupExpress');

var _setupExpress2 = _interopRequireDefault(_setupExpress);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _middleware = require('./middleware');

var _middleware2 = _interopRequireDefault(_middleware);

var _config = require('../config');

var _config2 = _interopRequireDefault(_config);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var app = (0, _express2.default)();
var PORT = process.env.PORT || 3000;

if (process.env.NODE_ENV !== 'production') {
  _dotenv2.default.config();
  // enable webpack hot module replacement
  var webpackDevMiddleware = require('webpack-dev-middleware');
  var webpackHotMiddleware = require('webpack-hot-middleware');
  var webpackConfig = require('../build/webpack.config');
  var devBrowserConfig = webpackConfig('browser');
  var compiler = (0, _webpack2.default)(devBrowserConfig);
  app.use(webpackDevMiddleware(compiler, {
    hot: true,
    stats: {
      hash: true
    },
    publicPath: devBrowserConfig.output.publicPath,
    filename: devBrowserConfig.output.filename
  }));

  app.use(webpackHotMiddleware(compiler, {
    log: console.log,
    path: '/__webpack_hmr',
    heartbeat: 10 * 1000
  }));

  app.use(function (req, res, next) {
    _fs2.default.readFile(_config2.default.paths.dist + '/stats.json', function (err, data) {
      if (err) console.error(err);
      global.hash = JSON.parse(data).hash;
      next();
    });
  });
}

(0, _setupExpress2.default)(app);

app.get('*', _middleware2.default);

app.listen(PORT);